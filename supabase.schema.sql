-- 1. å¯ç”¨ UUID æ‰©å±•ï¼ˆå¯é€‰ï¼Œè™½ç„¶å½“å‰è®¾è®¡ç”¨ Int/Varcharï¼Œä½†æ¨è UUIDï¼‰
create extension if not exists "uuid-ossp";

-- 2. æ¡Œå­è¡¨ (Table)
create table public.tables (
    table_id varchar primary key, -- ä¾‹å¦‚ 'A01', 'B02'
    current_order_group_id int,   -- æŒ‡å‘å½“å‰æ´»è·ƒçš„ order_groups.id
    status varchar default 'free', -- æ¡Œå°çŠ¶æ€: free, occupied
    created_at timestamp with time zone default timezone('utc'::text, now()) not null,
    updated_at timestamp with time zone default timezone('utc'::text, now()) not null
);

-- 3. è®¢å•ç»„è¡¨ (OrderGroup) - ç”¨äºèšåˆä¸€æ¬¡ç”¨é¤çš„æ‰€æœ‰å­è®¢å•
create table public.order_groups (
    id bigint generated by default as identity primary key,
    table_id varchar not null references public.tables(table_id),
    status varchar not null check (status in ('active', 'completed', 'cancelled')), -- æœªç»“/å·²ç»“
    total_amount numeric default 0, -- ç¼“å­˜æ€»é‡‘é¢
    created_at timestamp with time zone default timezone('utc'::text, now()) not null,
    updated_at timestamp with time zone default timezone('utc'::text, now()) not null
);

-- 4. å­è®¢å•è¡¨ (Order) - æ¯æ¬¡æ‰«ç ä¸‹å•ç”Ÿæˆä¸€æ¡
create table public.orders (
    id bigint generated by default as identity primary key,
    order_group_id bigint not null references public.order_groups(id),
    items jsonb not null, -- å­˜å‚¨å¿«ç…§: [{id, name, qty, price, options}]
    subtotal numeric not null,
    sequence_number int not null default 1, -- ç¬¬å‡ æ¬¡ä¸‹å•
    status varchar default 'pending', -- åˆ¶ä½œçŠ¶æ€: pending, cooking, done
    created_at timestamp with time zone default timezone('utc'::text, now()) not null
);

-- 5. åˆ†ç±»è¡¨ (Category)
create table public.categories (
    id bigint generated by default as identity primary key,
    name varchar not null unique,
    icon varchar default 'ğŸ½ï¸', -- å›¾æ ‡ emoji
    sort_order int default 0,
    is_active boolean default true,
    created_at timestamp with time zone default timezone('utc'::text, now()) not null
);

-- 6. èœå“è¡¨ (Dish) - å·²æ‰©å±•æ”¯æŒæ›´å¤šå­—æ®µ
create table public.dishes (
    id bigint generated by default as identity primary key,
    name varchar not null,
    description text, -- èœå“æè¿°
    price numeric not null,
    original_price numeric, -- åŸä»·ï¼ˆç”¨äºä¿ƒé”€æ˜¾ç¤ºï¼‰
    category varchar not null,
    image_url varchar,
    -- options æ ¼å¼: {"specs": [{"name": "è¾£åº¦", "required": false, "multi": false, "values": [{"name": "å¾®è¾£", "price": 0}]}]}
    options jsonb default '{"specs": []}'::jsonb, 
    is_available boolean default true, -- ä¸Šæ¶çŠ¶æ€
    is_recommended boolean default false, -- æ¨èèœå“
    sort_order int default 0, -- æ’åºæƒé‡
    created_at timestamp with time zone default timezone('utc'::text, now()) not null,
    updated_at timestamp with time zone default timezone('utc'::text, now()) not null
);

-- 7. å»ºç«‹å¤–é”®å…³è”ä»¥ç¡®ä¿æ•°æ®å®Œæ•´æ€§
alter table public.tables 
add constraint fk_current_group 
foreign key (current_order_group_id) 
references public.order_groups(id);

-- 8. åˆ›å»ºç´¢å¼•ä¼˜åŒ–æŸ¥è¯¢æ€§èƒ½
create index idx_dishes_category on public.dishes(category);
create index idx_dishes_sort_order on public.dishes(sort_order);
create index idx_dishes_available on public.dishes(is_available);
create index idx_categories_sort_order on public.categories(sort_order);

-- 9. æ’å…¥åˆ†ç±»æ•°æ®
insert into public.categories (name, icon, sort_order) values
('æ±¤é¢ç±»', 'ğŸœ', 1),
('æ‹Œé¢ç±»', 'ğŸ¥¢', 2),
('å¤–åŠ ç±»', 'â•', 3),
('é¢ç–™ç˜©ç±»', 'ğŸ¥Ÿ', 4),
('é¥®æ–™ç±»', 'ğŸ¥¤', 5)
on conflict (name) do nothing;

-- 10. æ’å…¥èœå“æ•°æ®
-- æ±¤é¢ç±»
insert into public.dishes (name, price, category) values
('é’èœè‚‰ä¸é¢', 15, 'æ±¤é¢ç±»'),
('é’èœé¸¡è›‹é¢', 15, 'æ±¤é¢ç±»'),
('ç‰‡å„¿å·', 15, 'æ±¤é¢ç±»'),
('å¤§æ’é¢', 24, 'æ±¤é¢ç±»'),
('å°æ’é¢', 26, 'æ±¤é¢ç±»'),
('ç‰›è‚‰é¢', 26, 'æ±¤é¢ç±»'),
('è‚šç‰‡é¢', 26, 'æ±¤é¢ç±»'),
('å¤§è‚ é¢', 26, 'æ±¤é¢ç±»'),
('é…±é¦™è‚ é¢', 26, 'æ±¤é¢ç±»'),
('é’èœæ²³è™¾é¢', 26, 'æ±¤é¢ç±»'),
('ä¸‰é²œé¢', 28, 'æ±¤é¢ç±»'),
('è…°èŠ±é¢', 26, 'æ±¤é¢ç±»'),
('æµ·é²œé¢', 30, 'æ±¤é¢ç±»'),
('æ²³è™¾å°æ’é¢', 35, 'æ±¤é¢ç±»'),
('æ²³è™¾å¤§æ’é¢', 35, 'æ±¤é¢ç±»'),
('æ²³è™¾ç‰›è‚‰é¢', 35, 'æ±¤é¢ç±»'),
('æ²³è™¾è‚šç‰‡é¢', 35, 'æ±¤é¢ç±»'),
('ç‰¹è‰²æµ·é²œé¢', 45, 'æ±¤é¢ç±»')
on conflict do nothing;

-- æ‹Œé¢ç±»
insert into public.dishes (name, price, category) values
('è‘±æ²¹æ‹Œé¢', 12, 'æ‹Œé¢ç±»'),
('æ²¹æ¸£æ‹Œé¢', 15, 'æ‹Œé¢ç±»'),
('å°æ’æ‹Œé¢', 26, 'æ‹Œé¢ç±»'),
('è‚šç‰‡æ‹Œé¢', 26, 'æ‹Œé¢ç±»'),
('ç‰›è‚‰æ‹Œé¢', 26, 'æ‹Œé¢ç±»'),
('æ²³è™¾æ‹Œé¢', 26, 'æ‹Œé¢ç±»')
on conflict do nothing;

-- é¢ç–™ç˜©ç±»
insert into public.dishes (name, price, category) values
('é’èœè‚‰ä¸é¢ç–™ç˜©', 17, 'é¢ç–™ç˜©ç±»'),
('ç¬‹å¹²è‚‰ä¸é¢ç–™ç˜©', 17, 'é¢ç–™ç˜©ç±»'),
('ä¸‰é²œé¢ç–™ç˜©', 30, 'é¢ç–™ç˜©ç±»'),
('æµ·é²œé¢ç–™ç˜©', 30, 'é¢ç–™ç˜©ç±»'),
('æ²³è™¾ç¬‹å¹²èœé¢ç–™ç˜©', 30, 'é¢ç–™ç˜©ç±»')
on conflict do nothing;

-- å¤–åŠ ç±»
insert into public.dishes (name, price, category) values
('å¤§æ’', 12, 'å¤–åŠ ç±»'),
('å°æ’', 15, 'å¤–åŠ ç±»'),
('æ²³è™¾', 15, 'å¤–åŠ ç±»'),
('é¸¡è›‹', 2, 'å¤–åŠ ç±»'),
('åŠ é¢', 2, 'å¤–åŠ ç±»'),
('æ²¹æ¸£', 3, 'å¤–åŠ ç±»')
on conflict do nothing;

-- é¥®æ–™ç±»
insert into public.dishes (name, price, category) values
('æå­å›­ç”œç‰›å¥¶', 6, 'é¥®æ–™ç±»'),
('çº¢ç‰›', 7, 'é¥®æ–™ç±»'),
('ç‹è€å‰å‡‰èŒ¶', 5, 'é¥®æ–™ç±»'),
('æŸšé¦™è°·', 7, 'é¥®æ–™ç±»'),
('å–œçˆ±æœå›­', 6, 'é¥®æ–™ç±»'),
('å¯å£å¯ä¹', 4, 'é¥®æ–™ç±»'),
('å†œå¤«å±±æ³‰èŒ¶Ï€', 6, 'é¥®æ–™ç±»'),
('åº·å¸ˆå‚…çŸ¿æ³‰æ°´', 3, 'é¥®æ–™ç±»'),
('æå­å›­è‰è“', 6, 'é¥®æ–™ç±»'),
('å•¤é…’ç“¶è£…', 7, 'é¥®æ–™ç±»'),
('æ¤°æ±', 5, 'é¥®æ–™ç±»'),
('è”æé¥®æ–™', 5, 'é¥®æ–™ç±»')
on conflict do nothing;

-- 11. æ’å…¥æ¡Œå°æ•°æ®
insert into public.tables (table_id) values 
('A01'), ('A02'), ('A03'), ('A04'), ('A05'), ('A06');
